from decimal import Decimal

from defabipedia.tokens import Abis as TokenAbis
from defabipedia.types import Chain
from eth_abi import encode
from karpatkit.helpers import get_balance
from karpatkit.test_utils.fork import local_node_eth_replay as local_node_eth
from pytest import approx

from roles_royce.protocols.morpho_blue.contract_methods import ApproveMorphoBlue, Supply, Withdraw


def test_approve():
    method = ApproveMorphoBlue(
        blockchain=Chain.ETHEREUM, token="0xa0b86991c6218b36c1d19d4a2e9eb0ce3606eb48", amount=100
    )
    assert (
        method.data
        == "0x095ea7b3000000000000000000000000bbbbbbbbbb9cc5e90e3b3af64bdaf62c37eeffcb0000000000000000000000000000000000000000000000000000000000000064"
    )


def test_supply():
    method = Supply(
        loan_token="0x6B175474E89094C44Da98b954EedeAC495271d0F",
        collateral_token="0x9D39A5DE30e57443BfF2A8307A4256c8797A3497",
        oracle="0x5D916980D5Ae1737a8330Bf24dF812b2911Aae25",
        irm="0x870aC11D48B15DB9a138Cf899d20F13F79Ba00BC",
        lltv=860000000000000000,
        assets=511564470921937213198106,
        shares=0,
        avatar="0x940901eD4dAE648AB3B107D6B83624148AD4d357",
        blockchain=Chain.ETHEREUM,
    )
    assert (
        method.data
        == "0xa99aad890000000000000000000000006b175474e89094c44da98b954eedeac495271d0f0000000000000000000000009d39a5de30e57443bff2a8307a4256c8797a34970000000000000000000000005d916980d5ae1737a8330bf24df812b2911aae25000000000000000000000000870ac11d48b15db9a138cf899d20f13f79ba00bc0000000000000000000000000000000000000000000000000bef55718ad60000000000000000000000000000000000000000000000006c53f72d6ec5ea380f1a0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000940901ed4dae648ab3b107d6b83624148ad4d35700000000000000000000000000000000000000000000000000000000000001200000000000000000000000000000000000000000000000000000000000000000"
    )


def test_withdraw():
    method = Withdraw(
        loan_token="0x0000206329b97DB379d5E1Bf586BbDB969C63274",
        collateral_token="0x95EeF579155cd2C5510F312c8fA39208c3Be01a8",
        oracle="0x1f083a4c51E6cAa627A8Cbe7452bF3D6eb815F57",
        irm="0x870aC11D48B15DB9a138Cf899d20F13F79Ba00BC",
        lltv=915000000000000000,
        assets=0,
        shares=6781465422189468960586975,
        avatar="0xA68b37C561D656a41E05874551979fE1C794206F",
        blockchain=Chain.ETHEREUM,
    )
    assert (
        method.data
        == "0x5c2bea490000000000000000000000000000206329b97db379d5e1bf586bbdb969c6327400000000000000000000000095eef579155cd2c5510f312c8fa39208c3be01a80000000000000000000000001f083a4c51e6caa627a8cbe7452bf3d6eb815f57000000000000000000000000870ac11d48b15db9a138cf899d20f13f79ba00bc0000000000000000000000000000000000000000000000000cb2bba6f17b80000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000059c07fa27b9a2ce127cdf000000000000000000000000a68b37c561d656a41e05874551979fe1c794206f000000000000000000000000a68b37c561d656a41e05874551979fe1c794206f"
    )

from unittest.mock import patch

import os
import json
import pytest
import subprocess
from pathlib import Path
import time
from roles_royce.toolshed.simulation import tenderly_simulate, simulate_tx, tenderly_share_simulation, \
    TenderlyCredentials


API_URL = "https://api.tenderly.co/api/v1/"
RESP_TEXT = '{"status": 200, "sim_data": {"transaction": {"hash": "0xd806d71445e3e627a4be27c82d7ab59c1370b2b8a9a2d0c0bc50cfb303927f28", "block_hash": "", "block_number": 17565000, "from": "0xf39fd6e51aad88f6f4ce6ab8827279cfffb92266", "gas": 1043653, "gas_price": 0, "gas_fee_cap": 0, "gas_tip_cap": 0, "cumulative_gas_used": 0, "gas_used": 29500, "effective_gas_price": 0, "input": "0x6928e74b000000000000000000000000dd1fe5ad401d4777ce89959b7fa587e569bf125d000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000c00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000400000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000044c32e7202000000000000000000000000000000000000000000000012c03e0fdb2d857add000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000", "nonce": 485, "to": "0x1cfb0cd7b1111bf2054615c7c491a15c4a3303cc", "index": 0, "value": "0x", "access_list": null, "status": false, "addresses": ["0xf39fd6e51aad88f6f4ce6ab8827279cfffb92266", "0x1cfb0cd7b1111bf2054615c7c491a15c4a3303cc", "0xd8dfc1d938d7d163c5231688341e9635e9011889"], "contract_ids": ["eth:1:0xf39fd6e51aad88f6f4ce6ab8827279cfffb92266", "eth:1:0x1cfb0cd7b1111bf2054615c7c491a15c4a3303cc", "eth:1:0xd8dfc1d938d7d163c5231688341e9635e9011889"], "network_id": "1", "timestamp": "2023-06-26T17:12:11Z", "function_selector": "", "l1_block_number": 0, "l1_timestamp": 0, "deposit_tx": false, "system_tx": false, "sig": {"v": "0x0", "r": "0x0", "s": "0x0"}, "transaction_info": {"contract_id": "eth:1:0xd8dfc1d938d7d163c5231688341e9635e9011889", "block_number": 17565000, "transaction_id": "0xd806d71445e3e627a4be27c82d7ab59c1370b2b8a9a2d0c0bc50cfb303927f28", "contract_address": "0xd8dfc1d938d7d163c5231688341e9635e9011889", "method": null, "parameters": null, "intrinsic_gas": 22800, "refund_gas": 0, "call_trace": {"hash": "0xd806d71445e3e627a4be27c82d7ab59c1370b2b8a9a2d0c0bc50cfb303927f28", "contract_name": "", "function_pc": 0, "function_op": "CALL", "absolute_position": 0, "caller_pc": 0, "caller_op": "CALL", "call_type": "CALL", "address": "0xf39fd6e51aad88f6f4ce6ab8827279cfffb92266", "from": "0xf39fd6e51aad88f6f4ce6ab8827279cfffb92266", "from_balance": "0", "to": "0x1cfb0cd7b1111bf2054615c7c491a15c4a3303cc", "to_balance": "0", "value": "0", "block_timestamp": "0001-01-01T00:00:00Z", "gas": 1020853, "gas_used": 6700, "intrinsic_gas": 22800, "storage_address": "0xf39fd6e51aad88f6f4ce6ab8827279cfffb92266", "input": "0x6928e74b000000000000000000000000dd1fe5ad401d4777ce89959b7fa587e569bf125d000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000c00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000400000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000044c32e7202000000000000000000000000000000000000000000000012c03e0fdb2d857add000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000", "nonce_diff": [{"address": "0xf39Fd6e51aad88F6F4ce6aB8827279cffFb92266", "original": "485", "dirty": "486"}], "output": "0x", "decoded_output": null, "error_absolute_position": 567, "error": "execution reverted", "error_op": "REVERT", "error_hex_data": "0x08c379a0000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000154d6f64756c65206e6f7420617574686f72697a65640000000000000000000000", "network_id": "1", "calls": [{"hash": "", "function_pc": 0, "function_op": "STOP", "absolute_position": 558, "caller_pc": 31, "caller_op": "DELEGATECALL", "call_type": "DELEGATECALL", "address": "0x1cfb0cd7b1111bf2054615c7c491a15c4a3303cc", "from": "0x1cfb0cd7b1111bf2054615c7c491a15c4a3303cc", "from_balance": "0", "to": "0xd8dfc1d938d7d163c5231688341e9635e9011889", "to_balance": "0", "value": null, "caller": {"address": "0xf39fd6e51aad88f6f4ce6ab8827279cfffb92266", "balance": "0"}, "block_timestamp": "0001-01-01T00:00:00Z", "gas": 1002255, "gas_used": 3966, "refund_gas": 15908, "storage_address": "0x1cfb0cd7b1111bf2054615c7c491a15c4a3303cc", "input": "0x6928e74b000000000000000000000000dd1fe5ad401d4777ce89959b7fa587e569bf125d000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000c00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000400000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000044c32e7202000000000000000000000000000000000000000000000012c03e0fdb2d857add000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000", "output": "0x", "decoded_output": null, "error_absolute_position": 557, "error": "execution reverted", "error_op": "REVERT", "error_reason": "Module not authorized", "network_id": "", "calls": [{"hash": "", "function_pc": 0, "function_op": "", "absolute_position": 557, "caller_pc": 0, "caller_op": "", "address": "0xd8dfc1d938d7d163c5231688341e9635e9011889", "from": "0xd8dfc1d938d7d163c5231688341e9635e9011889", "from_balance": null, "to": "0xd8dfc1d938d7d163c5231688341e9635e9011889", "to_balance": null, "value": null, "block_timestamp": "0001-01-01T00:00:00Z", "gas": 0, "gas_used": 0, "input": "0x", "output": "0x", "decoded_output": null, "error": "execution reverted", "error_op": "REVERT", "network_id": "", "calls": null}]}]}, "stack_trace": [{"file_index": null, "contract": "0xd8dfc1d938d7d163c5231688341e9635e9011889", "name": null, "line": null, "error": "execution reverted", "error_reason": "Module not authorized", "code": null, "op": "REVERT", "length": null}, {"file_index": null, "contract": "0x1cfb0cd7b1111bf2054615c7c491a15c4a3303cc", "name": null, "line": null, "error": null, "code": null, "op": "DELEGATECALL", "length": null}, {"file_index": null, "contract": "0x1cfb0cd7b1111bf2054615c7c491a15c4a3303cc", "name": "", "line": null, "error": null, "code": null, "op": "CALL", "length": null}], "logs": null, "balance_diff": null, "nonce_diff": [{"address": "0xf39Fd6e51aad88F6F4ce6aB8827279cffFb92266", "original": "485", "dirty": "486"}], "state_diff": null, "raw_state_diff": null, "console_logs": null, "asset_changes": null, "balance_changes": [], "created_at": "2023-06-26T17:12:11Z"}, "error_message": "Module not authorized", "error_info": {"error_message": "Module not authorized", "address": "0xd8dfc1d938d7d163c5231688341e9635e9011889"}, "method": "", "decoded_input": null, "call_trace": [{"call_type": "CALL", "from": "0xf39fd6e51aad88f6f4ce6ab8827279cfffb92266", "to": "0x1cfb0cd7b1111bf2054615c7c491a15c4a3303cc", "gas": 1020853, "gas_used": 6700, "address": "0x1cfb0cd7b1111bf2054615c7c491a15c4a3303cc", "error": "value:\\"execution reverted\\"", "subtraces": 1, "input": "0x6928e74b000000000000000000000000dd1fe5ad401d4777ce89959b7fa587e569bf125d000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000c00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000400000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000044c32e7202000000000000000000000000000000000000000000000012c03e0fdb2d857add000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000", "output": "0x08c379a0000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000154d6f64756c65206e6f7420617574686f72697a65640000000000000000000000", "errorMessage": "value:\\"Module not authorized\\""}, {"call_type": "DELEGATECALL", "from": "0x1cfb0cd7b1111bf2054615c7c491a15c4a3303cc", "to": "0xd8dfc1d938d7d163c5231688341e9635e9011889", "gas": 1002255, "gas_used": 3966, "address": "0xd8dfc1d938d7d163c5231688341e9635e9011889", "error": "value:\\"execution reverted\\"", "trace_address": [0], "input": "0x6928e74b000000000000000000000000dd1fe5ad401d4777ce89959b7fa587e569bf125d000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000c00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000400000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000044c32e7202000000000000000000000000000000000000000000000012c03e0fdb2d857add000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000", "output": "0x08c379a0000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000154d6f64756c65206e6f7420617574686f72697a65640000000000000000000000", "gas_in": 1020763, "gas_cost": 1004855, "errorMessage": "value:\\"Module not authorized\\""}]}, "simulation": {"id": "f08f93b3-e6be-40ec-b05d-0338089f5e1f", "project_id": "33d341cc-561e-4b0c-afc7-36b5e19ebd39", "owner_id": "3fe0ca33-185d-4533-9e44-291c991c13ba", "network_id": "1", "block_number": 17565000, "transaction_index": 0, "from": "0xf39Fd6e51aad88F6F4ce6aB8827279cffFb92266", "to": "0x1cFB0CD7B1111bf2054615C7C491a15C4A3303cc", "input": "0x6928e74b000000000000000000000000dd1fe5ad401d4777ce89959b7fa587e569bf125d000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000c00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000400000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000044c32e7202000000000000000000000000000000000000000000000012c03e0fdb2d857add000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000", "gas": 1043653, "gas_price": "0", "gas_used": 29500, "value": "0", "status": false, "access_list": null, "queue_origin": "", "block_header": {"number": "0x10c0548", "hash": "0x0000000000000000000000000000000000000000000000000000000000000000", "stateRoot": "0x1368001c8f42e41ec2295ce5a83eb982c5a56fe66b3818ace8a9636afd00fe23", "parentHash": "0x5715dd3c8f95dd16b132563febc94d74d1b4f705b65440adf9e70e93e406a24b", "sha3Uncles": "0x1dcc4de8dec75d7aab85b567b6ccd41ad312451b948a7413f0a142fd40d49347", "transactionsRoot": "0x755abbf8cccd6c5e015eb7a081d76325774904e7604d99db85dad8969fd06500", "receiptsRoot": "0xbc4c79de5ceb443df06cc4a9bf9c981e44159ca257b5782e55c334b922722c6d", "logsBloom": "0xeb25913b798992891d0222b0a11713b3187644990046b5d2010b34f8756aac0543650be336416908051a1b00a196150207157e6a9869382002058e56213ea9425982c7081444680c692b5b49824c80aa101023faacc61851b236cc64b424040d17c70cab320aa143ad4098e28e6e2c1b7810ad74802104245245845b0abee07203808b5442c6d91490c1744ac384c227040111e1ad0b8c8b4124486746b0a2ff8ea011c1c37b66a0fa93cde2beb72480a72c0e40ec220b0a296ea20e029c0871a37b76ab4608a4f303129296040f700524bc06ee8489e8962705715a22146466fbb2b81c878883c64a44d8f429822001968b98705998e85221103c8f5485fc71", "timestamp": "0x6499c6eb", "difficulty": "0x0", "gasLimit": "0x1c9c380", "gasUsed": "0xb92edc", "miner": "0x1f9090aae28b8a3dceadf281b0f12828e676c326", "extraData": "0x407273796e636275696c646572", "mixHash": "0x7741cd73fae24afec9cf123ed71f8f1de6fc6a938d7ffb7118533d9965061832", "nonce": "0x0000000000000000", "baseFeePerGas": "0x42c71d9ba", "size": "0x0", "totalDifficulty": "0x0", "uncles": null, "transactions": null}, "deposit_tx": false, "system_tx": false, "error_message": "Module not authorized", "nonce": 485, "addresses": ["0xf39fd6e51aad88f6f4ce6ab8827279cfffb92266", "0x1cfb0cd7b1111bf2054615c7c491a15c4a3303cc", "0xd8dfc1d938d7d163c5231688341e9635e9011889"], "contract_ids": ["eth:1:0xf39fd6e51aad88f6f4ce6ab8827279cfffb92266", "eth:1:0x1cfb0cd7b1111bf2054615c7c491a15c4a3303cc", "eth:1:0xd8dfc1d938d7d163c5231688341e9635e9011889"], "shared": false, "created_at": "2023-11-27T20:54:15.899135871Z"}, "contracts": [], "generated_access_list": [], "share_url": "https://dashboard.tenderly.co/shared/simulation/f08f93b3-e6be-40ec-b05d-0338089f5e1f"}}\n'
dao = 'GnosisDAO'
blockchain = 'ETHEREUM'
avatar_safe_address = '0x849D52316331967b6fF1198e5E32A0eB168D039d'
roles_mod_address = '0x1cFB0CD7B1111bf2054615C7C491a15C4A3303cc'
role = 4

transactions = [{'chainId': 1,
                 'data': '0x6928e74b000000000000000000000000dd1fe5ad401d4777ce89959b7fa587e569bf125d000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000c00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000400000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000044c32e7202000000000000000000000000000000000000000000000012c03e0fdb2d857add000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000',
                 'from': '0xf39Fd6e51aad88F6F4ce6aB8827279cffFb92266',
                 'gas': 1043653,
                 'maxFeePerGas': 3710601020,
                 'maxPriorityFeePerGas': 2608114460,
                 'nonce': 558,
                 'to': '0x1cFB0CD7B1111bf2054615C7C491a15C4A3303cc',
                 'value': 0}]

file_path_execute = os.path.join(Path(os.path.dirname(__file__)).resolve().parent.parent.parent, 'roles_royce','applications', 'panic_button_app','simulate.py')

@pytest.mark.parametrize("tx", transactions)
def test_simulate(monkeypatch, tx, requests_mock):
    monkeypatch.setenv('TENDERLY_ACCOUNT_ID', "foobarbaz-d123-4140-adfb-123978bc0ab9")
    monkeypatch.setenv('TENDERLY_PROJECT', "project")
    monkeypatch.setenv('TENDERLY_API_TOKEN', "MyAPiToken123123123")
    requests_mock.post(
        f"/api/v1/account/foobarbaz-d123-4140-adfb-123978bc0ab9/project/project/simulations/8a37d0fe-570d-40db-9f42-aa59c7aeb463/share",
        text=RESP_TEXT)
    
    arguments = [
    'python', file_path_execute,
    '--dao', dao,
    '--blockchain', blockchain,
    '--transaction', json.dumps(tx)
]
    print(file_path_execute)
    main = subprocess.run(arguments, capture_output=True, text=True)
    print(main.stdout)
    assert main.returncode == 0
    
from decimal import Decimal
from tests.utils import local_node_eth, accounts, create_simple_safe, steal_token
from tests.roles import setup_common_roles, deploy_roles, apply_presets
import os
import sys
import subprocess
from pathlib import Path
from defabipedia.tokens import Addresses
from defabipedia.types import Chain
from roles_royce.protocols import uniswap_v3
from roles_royce.constants import MAX_UINT256
from roles_royce import roles


def test_uniswap_v3_keeper(local_node_eth, accounts, monkeypatch):
    block = 19369027
    local_node_eth.set_block(block)
    w3 = local_node_eth.w3

    safe = create_simple_safe(w3=w3, owner=accounts[0])
    roles_mod_contract = deploy_roles(avatar=safe.address, w3=w3)
    setup_common_roles(
        safe, roles_mod_contract
    )  # We only care about creating role 1 and assigning it to accounts[1]

    presets = """{
  "version": "1.0",
  "chainId": "1",
  "meta": {
    "name": null,
    "description": "",
    "txBuilderVersion": "1.8.0"
  },
  "createdAt": 1709331335143,
  "transactions": [
    {
      "to": "0x1ffAdc16726dd4F91fF275b4bF50651801B06a86",
      "data": "0x5e8266950000000000000000000000000000000000000000000000000000000000000001000000000000000000000000a0b86991c6218b36c1d19d4a2e9eb0ce3606eb48",
      "value": "0"
    },
    {
      "to": "0x1ffAdc16726dd4F91fF275b4bF50651801B06a86",
      "data": "0x33a0480c0000000000000000000000000000000000000000000000000000000000000001000000000000000000000000a0b86991c6218b36c1d19d4a2e9eb0ce3606eb48095ea7b30000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000140000000000000000000000000000000000000000000000000000000000000018000000000000000000000000000000000000000000000000000000000000001c00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000020000000000000000000000000c36442b4a4522e871399cd717abdd847ab11fe88",
      "value": "0"
    },
    {
      "to": "0x1ffAdc16726dd4F91fF275b4bF50651801B06a86",
      "data": "0x5e8266950000000000000000000000000000000000000000000000000000000000000001000000000000000000000000c02aaa39b223fe8d0a0e5c4f27ead9083c756cc2",
      "value": "0"
    },
    {
      "to": "0x1ffAdc16726dd4F91fF275b4bF50651801B06a86",
      "data": "0x33a0480c0000000000000000000000000000000000000000000000000000000000000001000000000000000000000000c02aaa39b223fe8d0a0e5c4f27ead9083c756cc2095ea7b30000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000140000000000000000000000000000000000000000000000000000000000000018000000000000000000000000000000000000000000000000000000000000001c00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000020000000000000000000000000c36442b4a4522e871399cd717abdd847ab11fe88",
      "value": "0"
    },
    {
      "to": "0x1ffAdc16726dd4F91fF275b4bF50651801B06a86",
      "data": "0x5e8266950000000000000000000000000000000000000000000000000000000000000001000000000000000000000000c36442b4a4522e871399cd717abdd847ab11fe88",
      "value": "0"
    },
    {
      "to": "0x1ffAdc16726dd4F91fF275b4bF50651801B06a86",
      "data": "0x33a0480c0000000000000000000000000000000000000000000000000000000000000001000000000000000000000000c36442b4a4522e871399cd717abdd847ab11fe8888316456000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000026000000000000000000000000000000000000000000000000000000000000003c000000000000000000000000000000000000000000000000000000000000005200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a0000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000a0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a0000000000000000000000000000000000000000000000000000000000000140000000000000000000000000000000000000000000000000000000000000018000000000000000000000000000000000000000000000000000000000000001c000000000000000000000000000000000000000000000000000000000000001e00000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000022000000000000000000000000000000000000000000000000000000000000002400000000000000000000000000000000000000000000000000000000000000260000000000000000000000000000000000000000000000000000000000000028000000000000000000000000000000000000000000000000000000000000002a00000000000000000000000000000000000000000000000000000000000000020000000000000000000000000a0b86991c6218b36c1d19d4a2e9eb0ce3606eb480000000000000000000000000000000000000000000000000000000000000020000000000000000000000000c02aaa39b223fe8d0a0e5c4f27ead9083c756cc200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000020000000000000000000000000c01318bab7ee1f5ba734172bf7718b5dc6ec90e1",
      "value": "0"
    },
    {
      "to": "0x1ffAdc16726dd4F91fF275b4bF50651801B06a86",
      "data": "0x2fcf52d10000000000000000000000000000000000000000000000000000000000000001000000000000000000000000c36442b4a4522e871399cd717abdd847ab11fe880c49ccbe000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000",
      "value": "0"
    },
    {
      "to": "0x1ffAdc16726dd4F91fF275b4bF50651801B06a86",
      "data": "0x33a0480c0000000000000000000000000000000000000000000000000000000000000001000000000000000000000000c36442b4a4522e871399cd717abdd847ab11fe88fc6f7865000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000016000000000000000000000000000000000000000000000000000000000000001c00000000000000000000000000000000000000000000000000000000000000220000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000040000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000020000000000000000000000000c01318bab7ee1f5ba734172bf7718b5dc6ec90e1",
      "value": "0"
    }
  ]
}"""

    apply_presets(
        safe,
        roles_mod_contract,
        json_data=presets,
        replaces=[("c01318bab7ee1f5ba734172bf7718b5dc6ec90e1", safe.address[2:])],
    )

    WETH = Addresses[Chain.get_blockchain_from_web3(w3)].WETH
    USDC = Addresses[Chain.get_blockchain_from_web3(w3)].USDC

    ADDRESS_WITH_LOTS_OF_WETH = "0x8EB8a3b98659Cce290402893d0123abb75E3ab28"
    ADDRESS_WITH_LOTS_OF_USDC = "0xD6153F5af5679a75cC85D8974463545181f48772"
    steal_token(
        w3=w3,
        token=WETH,
        holder=ADDRESS_WITH_LOTS_OF_WETH,
        to=safe.address,
        amount=int(100e18),
    )
    steal_token(
        w3=w3,
        token=USDC,
        holder=ADDRESS_WITH_LOTS_OF_USDC,
        to=safe.address,
        amount=int(1_000_000e6),
    )
    safe.send(
        [
            uniswap_v3.ApproveForPositionsNFT(
                blockchain=Chain.get_blockchain_from_web3(w3),
                token=WETH,
                amount=MAX_UINT256,
            ),
            uniswap_v3.ApproveForPositionsNFT(
                blockchain=Chain.get_blockchain_from_web3(w3),
                token=USDC,
                amount=MAX_UINT256,
            ),
        ]
    )

    fee = uniswap_v3.FeeAmount.MEDIUM

    monkeypatch.setenv("AVATAR_SAFE_ADDRESS", safe.address)
    monkeypatch.setenv("ROLES_MOD_ADDRESS", roles_mod_contract.address)
    monkeypatch.setenv("ROLE", str(1))
    monkeypatch.setenv("PRIVATE_KEY", accounts[1].key.hex())
    monkeypatch.setenv("TOKEN0_ADDRESS", USDC)
    monkeypatch.setenv("TOKEN1_ADDRESS", WETH)
    monkeypatch.setenv("FEE", str(fee))
    monkeypatch.setenv("LOCAL_FORK_PORT", str(8546))
    pool = uniswap_v3.utils.Pool(w3, USDC, WETH, fee)

    monkeypatch.setenv("INITIAL_MIN_PRICE", str(float(pool.price * Decimal(0.9))))
    monkeypatch.setenv("INITIAL_MAX_PRICE", str(float(pool.price * Decimal(1.5))))
    monkeypatch.setenv("INITIAL_AMOUNT0", "")
    monkeypatch.setenv("INITIAL_AMOUNT1", str(int(1e18)))
    monkeypatch.setenv("MINIMUM_MIN_PRICE", str(0.0000001))
    monkeypatch.setenv("PRICE_RANGE_THRESHOLD", str(10))
    monkeypatch.setenv("PRICE_RANGE_MULTIPLIER", str(2))


    file_path_main = os.path.join(
        Path(os.path.dirname(__file__)).resolve().parent.parent.parent,
        "roles_royce",
        "applications",
        "uniswap_v3_keeper",
        "uniswap_v3_keeper.py",
    )

    # mint nft
    # mint_ntf_txns = uniswap_v3.mint_nft(
    #     w3=w3,
    #     avatar=safe.address,
    #     token0=USDC,
    #     token1=WETH,
    #     fee=fee,
    #     token0_min_price=token0_min_price,
    #     token0_max_price=token0_max_price,
    #     amount1_desired=int(1e18),
    # )
    # roles.send(
    #     mint_ntf_txns,
    #     role=1,
    #     private_key=accounts[1].key,
    #     roles_mod_address=roles_mod_contract.address,
    #     web3=w3,
    # )

    try:
        main = subprocess.run(
            args=[sys.executable, file_path_main],
            capture_output=True,
            text=True,
            timeout=120,
        )
    except subprocess.TimeoutExpired:
        pass
    except Exception as e:
        raise e
